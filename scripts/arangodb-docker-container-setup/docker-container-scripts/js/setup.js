print(">> Running Setup in Arangosh\n");

const users = require('@arangodb/users');

print("Create user: ", process.env.ARANGO_DB_USER);
if (users.save(process.env.ARANGO_DB_USER, process.env.ARANGO_DB_USER_PASSWORD)) {
  print("User created successfully\n");
}

print("Create database: ", process.env.ARANGO_DB_NAME);
if (db._createDatabase(process.env.ARANGO_DB_NAME)) {
  print("Database created successfully\n");
}
users.grantDatabase(process.env.ARANGO_DB_USER, process.env.ARANGO_DB_NAME, 'rw');

db._useDatabase(process.env.ARANGO_DB_NAME);

// Optionally load dummy data generated by app test
let testDataFlag = false;
if (process.env.ARANGO_DB_RUN_WITH_TEST_DATA == 'yes') {
  testDataFlag = true;
  print("Loading test data\n");
}
else {
  testDataFlag = false;
  print("Loading empty collections\n");
}

const testData = require(process.env.ARANGODB_DESTINATION_CONTAINER_DOCKER_SHARED_VOLUME_SCRIPTS_PATH + '/test-data/testData.json');

// TODO [https://www.pivotaltracker.com/story/show/182132515]
const reformatedTestData = {
  document: {
    ...testData.resources,
    categories: testData.categories,
    tags: testData.tags,
  },
  edge: {
    resource_edge_connections: testData.resource_edge_connections,
    category_edges: testData.categoryEdges,
  }
}

for (collectionType in reformatedTestData) {
  for (collectionName in reformatedTestData[collectionType]) {
    addCollectionAndData(collectionName, collectionType, reformatedTestData[collectionType][collectionName]);
  }
}

function addCollectionAndData(collectionName, collectionType, data) {
  print(`Attempting to add ${collectionType} collection "${collectionName}" to ${process.env.ARANGO_DB_NAME}`);
  let success = false;
  if (collectionType == 'document') {
    if (db._create(collectionName)) {
      success = true;
    }
  }
  else if (collectionType == 'edge') {
    if (db._createEdgeCollection(collectionName)) {
      success = true;
    }
  }

  if (success) {
    if (testDataFlag) {
      print(`Attempting to add data to collection "${collectionName}"`);
      data.forEach(document => {
        if (db._collection(collectionName).save(document)) {
          print(`Added document to Collection ${collectionName}`);
        }
        else {
          print(`Document could not be added to "${collectionName}"`);
        }
      });
    }
  }
}
